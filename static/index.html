<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Badge Test</title>
  <link rel="stylesheet" href="css/normalize.css" type="text/css" />
  <link rel="stylesheet" href="css/style.css" type="text/css" />
</head>
<body>
  <a href="https://github.com/stenington/badgetest"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub"></a>

  <div class="top mt">
    <div class="top-inner">
      <img class="badge" src="img/badge.png"/>
      <form class="mt">
        Issue <input class="badge-count" type="text" title="number of badges" value="1" /> badge(s) to
        <input class="email" type="text" placeholder="email" title="recipient email" /> on
        <span title="backpack server" class="servers"></span>
        <br/>
        <label><input class="hashed" type="checkbox" title="to test hashed/unhashed email support" /> hash email</label>
        <label><input class="non-unique" type="checkbox" title="to test duplicate badge handling" /> don't uniquify</label>
        <label><input class="modaless" type="checkbox" title="to use the modaless workflow" /> modaless</label>
        <br/>
        <div class="go-panel">
          <div class="loading">
            Loading from <span class="where"></span>...
            <img src="img/spinner.gif"/>
          </div>
          <div class="loaded">
            <input class="go" type="submit" value="Go"/>
          </div>
        </div>
      </form>
      <hr>
      <div class="advanced">
        <a class="toggle">Advanced options</a>
        <div class="mt mb server-controls toggled">
          <table class="server-config">
            <thead>
              <tr><th colspan="3">Servers:</th></tr>
              <tr><th>Name</th><th>Url</th><th></th></tr>
            </thead>
            <tbody>
              <tr class="add-control">
                <td><input type="text" class="name" placeholder="name" /></td>
                <td><input type="text" class="url" placeholder="issuer.js url" /></td>
                <td class="controls"><input type="button" value="Add" class="add"/></td>
              </tr>
            </tbody>
          </table>
          <input class="hmt reset" type="button" value="Reset servers" />
        </div>
      </div>
    </div>
  </div>

  <div class="test-area"></div>

  <script id="server-select-template" type="text/html">
    <select class="server-select">
      <% _.each(servers, function(server, index) { %>
      <option value="<%= index %>"><%= server.name %></option>
      <% }); %>
    </select>
  </script>

  <script id="server-list-template" type="text/html">
    <% _.each(servers, function(server, index) { %>
    <tr>
      <td><%= server.name %></td>
      <td><%= server.url %></td>
      <td class="controls">
        <input class="remove" type="button" value="Remove" data-index="<%= index %>"/>
      </td>
    </tr>
    <% }); %>
  </script>

  <!-- empty script where we'll jam the Issuer API when loaded -->
  <script id="issuer-api"></script>
  
  <script src="js/es5-shim.js"></script>
  <script src="js/consolelog.min.js"></script>

  <script src="js/jquery-1.9.1.js"></script>
  <script src="js/underscore.js"></script>
  <script src="js/backbone.js"></script>
  <script src="js/backbone.localStorage.js"></script>

  <script>

    /** --------------------------------------------- **/

    function buildAssertions(spec){
      var assertions = [];
      var origin = $(location).attr('protocol') + '//' + $(location).attr('host'); 
      var endpoint = spec.hashed ? 'hashed.json' : 'raw.json';

      for (var i = 0; i < spec.count; i++){
        var assertion = origin 
          + '/' + endpoint 
          + '?email=' + encodeURIComponent(spec.email);

        var overrides = {
          badge: {
            issuer: {
              origin: origin
            }
          }
        };

        if(spec.unique){
          var millis = (new Date()).getTime();
          overrides.badge.name = 'Badge ' + millis + '-' + (i+1);
        }

        assertion += '&override=' + encodeURIComponent(JSON.stringify(overrides));
        assertions[i] = assertion;
      }
      return assertions;
    }

    var IssuerAPI = function(){
      var self = this;

      var script = $('#issuer-api');

      self.reloadFrom = function(server) {
        self.trigger('reload', server.get('name'));
        script.attr('src', server.get('url'));
        return $.getScript(server.get('url'))
          .success(function(){
            self.trigger('success');
          })
          .fail(function(){
            self.trigger('error');
          });
      };

      _.extend(self, Backbone.Events);
    }

    /** --------------------------------------------- **/
    var Server = Backbone.Model.extend({});

    var ServerList = Backbone.Collection.extend({
      model: Server,
      localStorage: new Backbone.LocalStorage("badgetest-serverlist"),
      initialize: function() {
        this.on('add', function(server) { server.save(); });
        this.on('change', function(server) { server.save(); });
        this.on('remove', function(server) { server.destroy(); });
      },
      setDefault: function() {
        this.update([
          { name: 'development', url: 'http://dev.openbadges.org/issuer.js' },
          { name: 'staging', url: 'http://stage.openbadges.org/issuer.js' },
          { name: 'production', url: 'http://beta.openbadges.org/issuer.js' }
        ]);
      }
    });

    /** --------------------------------------------- **/

    var ServerSelect = Backbone.View.extend({
      events: {
        'change .server-select': 'reload'
      },

      reload: function(evt) { 
        this.$el.find('.server-select').removeClass('loaded');
        var index = $(evt.target).val();
        this.issuerAPI.reloadFrom(this.collection.at(index));

      },

      initialize: function(opts) {
        this.issuerAPI = opts.issuerAPI;
        var that = this; 
        this.issuerAPI.on('success', function(){
          that.$el.find('.server-select').addClass('loaded');
        });

        this.listenTo(this.collection, "change", this.render);
        this.listenTo(this.collection, "add", this.render);
        this.listenTo(this.collection, "remove", this.render);
        this.template = _.template($('#server-select-template').html());
      },

      render: function() {
        this.$el.html(this.template({ servers: this.collection.toJSON() }));
      }
    });

    var ServerControls = Backbone.View.extend({
      events: {
        'click .remove': 'remove',
        'click .add': 'add',
        'click .reset': 'reset'
      },

      initialize: function(opts) {
        this.listenTo(this.collection, "change", this.render);
        this.listenTo(this.collection, "add", this.render);
        this.listenTo(this.collection, "remove", this.render);
        this.template = _.template($('#server-list-template').html());
      },

      render: function() {
        var tbody = this.$el.find('.server-config tbody');
        tbody.find('tr:not(.add-control)').remove();
        tbody.prepend(this.template({ servers: this.collection.toJSON() }));
      },

      remove: function(evt) {
        var index = $(evt.target).attr('data-index');
        this.collection.remove(this.collection.at(index));
      },

      add: function(evt) {
        this.collection.add({
          name: this.$el.find('.add-control .name').val(),
          url: this.$el.find('.add-control .url').val()
        });
      },

      reset: function(evt) {
        this.collection.setDefault();
      }
    });

    var TogglePanel = Backbone.View.extend({
      events: {
        'click .toggle': 'toggle'
      },
      
      initialize: function(opts) {
        if (opts.startHidden) 
          this.$el.find('.toggled').toggle(false);
      }, 

      toggle: function() {
        this.$el.find('.toggled').slideToggle('fast');
      }
    });

    var GoControl = Backbone.View.extend({
      events: {
        'click .go': 'go'
      },

      go: function() {
        try {
          var assertions = buildAssertions({
            count: $('.badge-count').val(),
            email: $('.email').val(),
            hashed: $('.hashed').is(':checked'),
            unique: !$('.non-unique').is(':checked')
          });
          log('Assertions:', assertions);
          if ($('.modaless').is(':checked')) {
            OpenBadges.issue_no_modal(assertions);
          }
          else {
            OpenBadges.issue(assertions);
          }
        }
        catch (ex) {
          log(ex);
        }
        return false;
      },

      initialize: function(opts) {
        this.issuerAPI = opts.issuerAPI;
        this.$el.find('.loaded').hide();
        var that = this;
        this.issuerAPI.on('reload', function(from){ that.loading(from); });
        this.issuerAPI.on('success', function(){ that.loaded(); });
      },

      loading: function(from) {
        this.$el.find('.where').html(from);
        this.$el.find('.loading').toggle(true);
        this.$el.find('.loaded').toggle(false);
      },

      loaded: function() {
        this.$el.find('.loading').toggle(false);
        this.$el.find('.loaded').toggle(true);
      }

    });
    /** --------------------------------------------- **/

    var firstVisit = (localStorage.getItem('badgetest-serverlist') === null);
    var servers = new ServerList();
    if (firstVisit) {
      log('setting default');
      servers.setDefault();
    }
    else {
      servers.fetch({
        error: function(servers) { 
          log('error fetching servers, using defaults');
          servers.setDefault(); 
        }
      });
    }

    var issuerAPI = new IssuerAPI();
    issuerAPI.reloadFrom(servers.at(0));
    issuerAPI.on('reload', function(){
      log('reloaded');
    });
    issuerAPI.on('error', function(){
      log('reload error');
    });

    var advancedOptions = new TogglePanel({
      el: $('.advanced'),
      startHidden: true
    });

    var serversView = new ServerControls({
      el: $('.server-controls'),
      collection: servers
    });
    var serverSelect = new ServerSelect({
      el: $('.servers'),
      collection: servers,
      issuerAPI: issuerAPI
    });
    serverSelect.render();
    serversView.render();

    var goControl = new GoControl({
      el: $('.go-panel'),
      issuerAPI: issuerAPI
    });
      
  </script>
</body>
</html>